<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Add New Music</title>
    <style>
        .error { color: red; }
        .success { color: green; }
        #newArtistFields { display: none; } /* Nasconde i campi del nuovo artista inizialmente */
    </style>
</head>
<body>
<h1>Add New Music</h1>

<!-- Messaggi di feedback -->
<div th:if="${errorMessage}" class="error">
    <p th:text="${errorMessage}"></p>
</div>
<div th:if="${successMessage}" class="success">
    <p th:text="${successMessage}"></p>
</div>

<form th:action="@{/music/add}" method="post" enctype="multipart/form-data" th:object="${music}">

    <!-- Campi Musica -->
    <div>
        <label for="title">Title:</label>
        <input type="text" id="title" th:field="*{title}" required>
        <span th:if="${#fields.hasErrors('title')}" th:errors="*{title}" class="error"></span>
    </div>
    <div>
        <label for="lyrics">Lyrics:</label>
        <textarea id="lyrics" th:field="*{lyrics}"></textarea>
        <span th:if="${#fields.hasErrors('lyrics')}" th:errors="*{lyrics}" class="error"></span>
    </div>
    <div>
        <label for="audioFile">Audio File (MP3, WAV, OGG):</label>
        <input type="file" id="audioFile" name="audioFile" accept=".mp3,.wav,.ogg" required>
    </div>

    <hr>

    <h2>Search Artist</h2>

    <!-- Barra di ricerca -->
    <div>
        <label for="artistSearch">Search Artist by Name:</label>
        <input type="text" id="artistSearch" placeholder="Type to search artist...">
    </div>

    <!-- Lista dinamica degli artisti -->
    <ul id="artistList"></ul>

    <!-- Sezione per aggiungere nuovo artista (inizialmente nascosta) -->
    <div id="newArtistFields" style="display:none;">
        <h3>Add New Artist</h3>
        <div>
            <label for="name">Name:</label>
            <input type="text" id="name" th:field="${name}" placeholder="Enter artist name..." required>
        </div>
        <div>
            <label for="newDescription">Description:</label>
            <textarea id="newDescription" placeholder="Enter artist description..."></textarea>
        </div>
    </div>

    <script>
        const searchField = document.getElementById('artistSearch');
        const artistList = document.getElementById('artistList');
        const newArtistFields = document.getElementById('newArtistFields');

        // Funzione per cercare artisti
        async function searchArtists(query) {
            try {
                const response = await fetch(`/searchArtists?query=${query}`);
                const results = await response.json();

                // Pulizia della lista e aggiornamento con i nuovi risultati
                artistList.innerHTML = '';

                if (results.length === 0) {
                    // Mostra un pulsante che consente di aggiungere un nuovo artista se non ci sono risultati
                    artistList.innerHTML = `
                    <li>
                        <span>No artist found</span>
                        <button class="add-new-artist-btn" onclick="showNewArtistSection()">+ Add Artist</button>
                    </li>`;
                } else {
                    // Popolare la lista con gli artisti restituiti
                    results.forEach((artist, index) => {
                        const artistElement = document.createElement('li');
                        artistElement.innerHTML = `
                        <span>${artist.name}</span>
                        ${index === 0 ? '<button class="add-new-artist-btn" onclick="showNewArtistSection()">+ Add Artist</button>' : ''}
                    `;
                        artistList.appendChild(artistElement);
                    });
                }
            } catch (err) {
                console.error('Error fetching artists:', err);
            }
        }

        // Gestore evento per input passivo nella barra di ricerca
        searchField.addEventListener('input', function () {
            console.log("Search query:", this.value); // Log per debugging
            const query = this.value.trim();
            if (query.length > 0) {
                searchArtists(query);
            } else {
                // Se il campo Ã¨ vuoto, svuota la lista
                artistList.innerHTML = '';
            }
        });

        // Mostrare la sezione per aggiungere un nuovo artista
        function showNewArtistSection() {
            artistList.style.display = 'none'; // Nascondere la lista corrente
            newArtistFields.style.display = 'block'; // Mostrare il form per il nuovo artista
        }
    </script>

</form>

<div>
    <button type="submit">Submit</button>
</div>


</body>
</html>