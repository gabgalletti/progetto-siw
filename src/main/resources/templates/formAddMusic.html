<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Add New Music</title>
    <style>
        .error { color: red; }
        .success { color: green; }
        #newArtistFields { display: none; } /* Nasconde i campi del nuovo artista inizialmente */
    </style>
</head>
<body>
<h1>Add New Music</h1>

<!-- Messaggi di feedback -->
<div th:if="${errorMessage}" class="error">
    <p th:text="${errorMessage}"></p>
</div>
<div th:if="${successMessage}" class="success">
    <p th:text="${successMessage}"></p>
</div>

<form th:action="@{/music/add}" method="post" enctype="multipart/form-data" th:object="${music}">

    <!-- Campi Musica -->
    <div>
        <label for="title">Title:</label>
        <input type="text" id="title" th:field="*{title}" required>
        <span th:if="${#fields.hasErrors('title')}" th:errors="*{title}" class="error"></span>
    </div>
    <div>
        <label for="lyrics">Lyrics:</label>
        <textarea id="lyrics" th:field="*{lyrics}"></textarea>
        <span th:if="${#fields.hasErrors('lyrics')}" th:errors="*{lyrics}" class="error"></span>
    </div>
    <div>
        <label for="audioFile">Audio File (MP3, WAV, OGG):</label>
        <input type="file" id="audioFile" name="audioFile" accept=".mp3,.wav,.ogg" required>
    </div>

    <hr>

    <h2>Search Artist</h2>

    <!-- Barra di ricerca -->
    <div>
        <label for="artistSearch">Search Artist by Name:</label>
        <input type="text" id="artistSearch" placeholder="Type to search artist...">
    </div>
    <div id="addArtistButtonContainer">
        <button class="add-new-artist-btn" onclick="showNewArtistSection()">+ Add Artist</button>
    </div>

    <!-- Lista dinamica degli artisti -->
    <ul id="artistList"></ul>

    <!-- Campo nascosto per l'artista selezionato -->
    <input type="hidden" id="selectedArtistId" name="selectedArtistId" />

    <!-- Sezione per aggiungere nuovo artista (inizialmente nascosta) -->
    <div id="newArtistFields" th:object="${newArtist}" style="display:none;">
        <h3>Add New Artist</h3>
        <div>
            <label for="name">Name:</label>
            <input type="text" id="name" th:field="*{name}" placeholder="Enter artist name..." required>
        </div>
        <div>
            <label for="newDescription">Description:</label>
            <textarea id="newDescription" th:field="*{description}" placeholder="Enter artist description..."></textarea>
        </div>
    </div>

    <script>
        const searchField = document.getElementById('artistSearch');
        const artistList = document.getElementById('artistList');
        const newArtistFields = document.getElementById('newArtistFields');

        // Funzione per cercare artisti
        async function searchArtists(query) {
            try {
                const response = await fetch(`/searchArtists?query=${query}`);
                const results = await response.json();

                // Pulizia della sola lista (non del pulsante)
                artistList.innerHTML = '';

                if (results.length === 0) {
                    const noArtistElement = document.createElement('li');
                    noArtistElement.textContent = 'No artist found';
                    artistList.appendChild(noArtistElement);
                } else {
                    results.forEach((artist) => {
                        const liElement = document.createElement('li');
                        liElement.textContent = artist.name; // Inserisci il nome dell'artista nel tag <li>
                        liElement.setAttribute('data-id', artist.id); // Aggiungi data-id con l'id dell'artista
                        liElement.style.cursor = 'pointer'; // Assicurati che sembri cliccabile con il cursore 'pointer'
                        artistList.appendChild(liElement);
                    });

                }
            } catch (error) {
                console.error('Error fetching artists:', error);
            }
        }

        artistList.addEventListener('click', function (e) {
            if (e.target && e.target.tagName === 'LI') {
                // Ottieni l'ID dell'artista selezionato dal data-id
                const selectedId = e.target.getAttribute('data-id');

                // Imposta il valore nel campo nascosto
                const hiddenField = document.getElementById('selectedArtistId');
                hiddenField.value = selectedId;

                // Evidenzia l'artista selezionato (opzionale)
                Array.from(artistList.children).forEach(li => li.classList.remove('selected')); // Rimuove selezioni precedenti
                e.target.classList.add('selected'); // Aggiunge lo stile al selezionato
            }
        });



        // Gestore evento per input passivo nella barra di ricerca
        searchField.addEventListener('input', function () {
            console.log("Search query:", this.value); // Log per debugging
            const query = this.value.trim();
            if (query.length > 0) {
                searchArtists(query);
            } else {
                // Se il campo Ã¨ vuoto, svuota la lista
                artistList.innerHTML = '';
            }
        });

        // Mostrare la sezione per aggiungere un nuovo artista
        function showNewArtistSection() {
            artistList.style.display = 'none'; // Nascondere la lista corrente
            newArtistFields.style.display = 'block'; // Mostrare il form per il nuovo artista
        }
    </script>
    <div>
        <button type="submit" id="submitBtn">Submit</button>
    </div>
</form>




</body>
</html>